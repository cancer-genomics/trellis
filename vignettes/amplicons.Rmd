---
title: "Identifying linked amplicons"
author: "Robert Scharpf"
date: \today
output: BiocStyle::pdf_document
vignette: >
  %\VignetteIndexEntry{Overview of svcnvs package}
  %\VignetteEngine{knitr::rmarkdown}
  %\usepackage[utf8]{inputenc} 
---

# Introduction

This vignette illustrates the workflow for identifying linked amplicons.

# Workflow

```{r packages}
library(Rsamtools)
library(svpreprocess)
library(svcnvs)
```

We assume the bin-level estimates of coverage have been normalized, transformed
to the log-scale, and segmented. We load the segmented log ratios from the
ovarian cell CGOV44T and the corresponding BamView.

```{r load_data}
cv.extdata <- system.file("extdata", package="svcnvs")
segs <- readRDS(file.path(cv.extdata, "cgov44t_segments.rds"))
extdata <- system.file("extdata", package="svbams")
bview <- BamViews(bamPaths=file.path(extdata, "cgov44t_revised.bam"))
```

Next, we load sequence- and germline-based filters.

```{r filters}
library(svfilters.hg19)
data(germline_filters)
```

A default set of parameters for linking amplicons can be generated using the function `ampliconParams`:

```{r params}
params <- ampliconParams()
```

An initial amplicon graph (with no edges) is constructed based on a hard
threshold of the segment means. The print method provides various summary
statistics of the data contained in this object, including the number of
amplicons, the number of links between the amplicons (currently 0), the total
size of the sequence-based filters (234.47 Mb), and the total size of the
amplicons.

```{r initialgraph}
params[["AMP_THR"]]
ag <- svcnvs:::makeAGraph(segs, germline_filters, params)
print(ag)
```

The four amplicons in this initial graph serve as seeds. We next evaluate
whether any of the segments can be merged. In particular, if two adjacent
segments have an absolute difference of means less than `MIN_SEGMEAN_DIFF`, the
adjacent segments are merged.

```{r joinNear}
params[["MIN_SEGMEAN_DIFF"]]
merged <- joinNearGRanges(ranges(ag), params)
names(merged) <- ampliconNames(merged)
nmerged <- length(ranges(ag)) - length(merged)
nmerged
```

We use improperly paired reads to link amplicons. First, we extract the
improperly paired reads and then we evaluate whether there are duplications
flanking the seed amplicons that can be linked to the seeds by the improperly
paired reads. In order to link the flanking segments to the seeds, we require
the adjacent segments to have mean log ratios consistent with a duplication
(`LOW_THR`).

```{r improperlyPaired}
params[["LOW_THR"]]
rp <- svalignments::get_readpairs(ag, bamPaths(bview))
ag <- addFocalDupsFlankingAmplicon(ag, rp, LOW_THR)
ag
```

TODO: what does this do. how does the graph change? What do these segments look
like?

```{r focalAmpDup}
qr <- focalAmpliconDupRanges(ag, LOW_THR=params[["LOW_THR"]],
                             MAX_SIZE=500e3)
queryRanges(ag) <- qr
qr
```
